*ñ=====================================**ñTestsñaroundñañ"new"ñfloating-point*ñrepresentationñwhichñisñrelatively*ñcompactñandñfast.**ñ=====================================**ñFormat:**ñEEEEEEEEñNNNNNNNNñNNNNNNNN*ñE=EXPO*ñN=-32768ñ..ñ32767**ñ=====================================**ñRepresents*óxñ=ñNñ*ñ2**E**ñNormalizedñformñisñwhenñtheñtwoñmost*ñsignificativeñbitsñofñNñareñnotñthe*ñsame.**ñ=====================================**ñ(c)ñSamuelñDEVULDERñ-ñMayñ2020**ñinspiredñby*õhttp://tinyurl.com/yxng3vau**ñ=====================================*ñConventions:*ñ=====================================*ñFloating-pointñoperationsñareñstack-*ñbasedñ(registerñUñisñused).ñComments*ñindicatesñstack-valuesñlikeñthis:*ü(beforeñ--ñafter)**ñForñspeedñreason,ñfloatingñpoint*ñoperationsñtypicallyñtrashñtheñA*ñandñBñregistersñandñpossiblyñtheñX*ñregisterñasñwell.ñConsiderñthem*ñasñdirtyñwhenñcalling.ñSameñwith*ñCC-flags.*ñ=====================================øorgõ$9000*ñ=====================================*ñsomeñhelpfulñmacros*ñ=====================================*ñcleardclrdôMACROølddõ#0øENDM*ñnegateñd-regnegdôMACROønegaønegbøsbcaô#0øENDM*ñarithmeticñshiftñrightñd-regasrdôMACROøasraørorbøENDM*ñlogicalñshiftñrightñd-reglsrdôMACROølsraørorbøENDM*ñshiftñleftñd-reglsldôMACROølslbørolaøENDM*ñrotateñrightñd-regrordôMACROøroraørorbøENDM*ñrotateñleftñd-regroldôMACROørolbørolaøENDM*ñskipñnextñ2ñbytesSKIP2óMACROøfcbõ$8Cõ;ñSKIP2ñ(CMPXñ#NøENDM*ñskipñnextñbyteSKIP1óMACROøfcbõ$81õ;ñSKIPñ(CMPAñ#N)øENDM*ñdeclareñañself-modifyingñcodeñvariableVARõMACRO\0ösetõ*-\1øENDM*ñdefineñañstackDOSTCKòMACRODO9\0ósetõ0DO8\0ósetõ0DO7\0ósetõ0DO6\0ósetõ0DO5\0ósetõ0DO4\0ósetõ0DO3\0ósetõ0DO2\0ósetõ0DO1\0ósetõ0øENDM*ñdefaultñstackøDOSTCKòdefDO_cptòSETõ0*ñpushñvalueñontoñstackDOPUSHòMACROóQUIETøIFNEôDO9\0STACKñOVERFLOWøENDCDO9\0ósetõDO8\0DO8\0ósetõDO7\0DO7\0ósetõDO6\0DO6\0ósetõDO5\0DO5\0ósetõDO4\0DO4\0ósetõDO3\0DO3\0ósetõDO2\0DO2\0ósetõDO1\0DO1\0ósetõ\1øENDM*ñpopñvalueñoutñofñstackDOPOPóMACROóQUIETøIFEQôDO1\0STACKñUNDERFLOWøENDCDO1\0ósetõDO2\0DO2\0ósetõDO3\0DO3\0ósetõDO4\0DO4\0ósetõDO5\0DO5\0ósetõDO6\0DO6\0ósetõDO7\0DO7\0ósetõDO8\0DO8\0ósetõDO9\0DO9\0ósetõ0øENDM*ñmacroñgeneratingñsymbolsñfromñnumber*ñDOGENñNUM,ARG1,ARG2,SYMBOLDOGENóMACROóQUIETôIFò\0øIFEQô(\0&7)-0øDOGENó(\0<-3),\1,\2,\30øENDCøIFEQô(\0&7)-1øDOGENó(\0<-3),\1,\2,\31øENDCøIFEQô(\0&7)-2øDOGENó(\0<-3),\1,\2,\32øENDCøIFEQô(\0&7)-3øDOGENó(\0<-3),\1,\2,\33øENDCøIFEQô(\0&7)-4øDOGENó(\0<-3),\1,\2,\34øENDCøIFEQô(\0&7)-5øDOGENó(\0<-3),\1,\2,\35øENDCøIFEQô(\0&7)-6øDOGENó(\0<-3),\1,\2,\36øENDCøIFEQô(\0&7)-7øDOGENó(\0<-3),\1,\2,\37øENDCôELSEø\1ö\2,\3ôENDCøENDM*ñsetsñARG1ñtoñARG2DOSET1òMACROóQUIET\0ñsetñ\1øENDM*ñsetsñARG2ñtoñARG1DOSET2òMACROóQUIET\1ñsetñ\0øENDM*ñsetsñREDO/EXITñvaluesñfromñstackñvalueDOSETóMACROóQUIETøIFöDO1deføDOGENóDO1def,DOSET1,EXIT,DOLVEøDOGENóDO1def,DOSET1,REDO,DOENTøENDCøIFöDO2deføDOGENóDO2def,DOSET1,EXIT2,DOLVøDOGENóDO2def,DOSET1,REDO2,DOENøENDCøIFöDO3deføDOGENóDO3def,DOSET1,EXIT3,DOLVøDOGENóDO3def,DOSET1,REDO3,DOENøENDCøENDM*ñbeginningñofñañblockDOöMACROóQUIETDO_cptòsetõDO_cpt+1øDOPUSHòdef,DO_cptøDOGENóDO1def,DOSET2,*,DOENTøDOSETøENDM*ñendñofñblockDONEôMACROóQUIETøDOGENóDO1def,DOSET2,*,DOLVEøDOPOPódeføDOSETøENDM*ñencodeñbranchñcodeñintoñnumberDO_raósetõ$20DO_rnósetõ$21DO_hiósetõ$22DO_lsósetõ$23DO_hsósetõ$24DO_loósetõ$25DO_neósetõ$26DO_eqósetõ$27DO_vcósetõ$28DO_vsósetõ$29DO_plósetõ$2ADO_miósetõ$2BDO_geósetõ$2CDO_ltósetõ$2DDO_gtósetõ$2EDO_leósetõ$2FDO_ccósetõ$24DO_csósetõ$25*ñdefineñbranchñpairsDO_negòMACRODO__\0òsetõDO_\1DO__\1òsetõDO_\0øENDMøDO_negòra,rnøDO_negòeq,neøDO_negòmi,pløDO_negòvs,vcøDO_negòcs,ccøDO_negògt,leøDO_negòge,ltøDO_negòhi,lsøDO_negòhs,loDO_lbròSETõ0DOLBRóMACROóQUIETDO_lbròsetõ1øENDM*ñgenerateñañbranchñfromñañcoded-branchDO_br_òMACROóQUIETøIFEQô\1-DO_\0øIFEQôDO_lbrøb\0õ\2øELSEølb\0ô\2øENDCøechoô;ó--------------------øENDCøENDMDO_bróMACROóQUIETøIFEQô\0-DO_raøIFEQôDO_lbrøbraõ\1øELSEøjmpõ\1øENDCøechoô;ó--------------------øENDCøDO_br_òrn,\0,\1øDO_br_òne,\0,\1øDO_br_òeq,\0,\1øDO_br_òlt,\0,\1øDO_br_òge,\0,\1øDO_br_ògt,\0,\1øDO_br_òle,\0,\1øDO_br_òmi,\0,\1øDO_br_òpl,\0,\1øDO_br_òvs,\0,\1øDO_br_òvc,\0,\1øDO_br_òcs,\0,\1øDO_br_òcc,\0,\1øDO_br_òhi,\0,\1øDO_br_òls,\0,\1øENDM*ñDOñ...ñWHILEñccWHILEóMACROóQUIETøDO_bróDO_\0,REDOøDONEDO_lbròSETõ0øENDM*ñDOIFñccñ..ñDOELIFñccñ..ñDOELIFñccñ..ñDDOIFôMACROóQUIETøDOøDO_bróDO__\0,EXITDO_lbròSETõ0øENDMDOELSEòMACROóQUIETDO_cptòSETõDO_cpt+1øDOGENóDO_cpt,DOSET1,REDO,DOENTøDOGENóDO_cpt,DOSET1,EXIT,DOLVEøDO_bróDO_ra,EXITøDOGENóDO_cpt,DOSET2,*,DOENTøDOGENóDO1def,DOSET2,*,DOLVEDO1defòSETõDO_cptDO_lbròSETõ0øENDMfmulfinvfdivfsubòbsrñfnegfaddòldbó2,uòsubbò5,uòstbó,-sòDOLBRòDOIFñneôDOIFñgtölddñ,uöDOIFñneølsldøDOIFñvsúrordúbrañEXIT2øDONEødecñ,søbneñREDO+2öDONEöstdñ,uôDOELIFñltölddñ3,uöDOIFñneølsldøDOIFñvsúrordúbrañEXIT2øDONEøincñ,søbneñREDO+2öDONEöstdñ3,uôDONEôtstñ,sñ;ñzzzòDONEòlddó,uòadddò3,uòDOIFñcsôrordôincñ5,uôbvsñfovfòDONEòleauò3,uòstdó,uòpulsñb,pcftckòbsrñfswpfdrpòleauò3,uòrtsfoneòldbñ#1fldbòsexflddòpshuñd,dpòldbñ#16òstbñ2,uòrtsfldxòlddò,x++òpshuñdòldbò,x+òpshuñbòrtsfstxòpuluñdòstdñ,xòldbñ,u+òstbñ2,xòrtsftstòlddñ,uòrtsfswpòlddñ,uòldxñ3,uòstdñ3,uòstxñ,uòldañ2,uòldbñ5,uòstañ5,uòstbñ2,uòrtsfdupòldbò,uó;ñ4òldxò1,uò;ñ6òpshuñb,xò;ñ8ñ=>ñ18fnopòrtsfhlfòdecñ2,uòbvcñfnopfclròclrdòstdñ,uòrtsfdblòincñ2,uòbvsñfovfòrtsfovfòlddñ,uòbeqñfnopòlddñ#$7fffòstañ2,uòtstñ,uòDOIFñmiôclrdòDONEòSTDñ,uòrtsfnegòclrdòsubdò,uô;ñ6òDOIFñvsôlsraö;ñ2ôincó2,uñ;ñ7ôbvsñfovfò;ñ3òDONEòstdó,uò;ñ5ñ=>ñ17ñ(32)òrtsfnrmòlddó,uò;ñ5òDOIFñneôlsldôbvsñEXITôDOödecñ2,söbvsñfclrölsldôWHILEñvcôrordôstdó,uòDONEòrtsfaddònegó,uònegò1,uòsòlddò,uó;ñ5òpshuñdô;ñ7òldbò4,uò;ñ5òstbò,-uò;ñ6ñ=>ñ23òpuluñd,dpñ;ñ8òpshuñd,dpñ;ñ8òpshuñd,dpñ;ñ8ñ=>ñ24òlddò,uó;ñ5òleauñ-3,uñ;ñ5òstdò,uó;ñ5òldbò5,uò;ñ5òstbò2,uò;ñ5ñ=>ñ25*ñ=====================================*ñStackñmanipulation*ñ=====================================*ñ(ña0ñ..ñanñ--ña1ñ..ñanña0ñ)ñn=B-regfprollòpshsòuù;ñreferenceñptròbsrófpindxbó;ñx=u+*bòlddó2,x÷;ñcopyña0ñafteròstdó-2,uö;ñendñofñstackòlddó,xòstdó-4,uòleauò4,x÷;ñprepareñuòDOôlddó-8,uô;ñgetñai+1ôldxó-6,uôpshuòd,xõ;ñwriteñtoñaiôcmpuò,sö;ñfinishedñ?òWHILEóneö;ñnoñ=>ñloopòpulsôu,pc*ñ(ña0ñ..ñanñ--ña0ñ..ñanña0ñ)fppickòldxó#fpldxô;ñstackñtrickñtoñcallòpshsòxù;ñfpldxñonñreturn*ñcomputeñx=u+4*bñ(unsigned)fpindxbòleaxò,uø;ñx=Uòabxý;ñx=u+bòabxý;ñx=u+b+bòabxý;ñx=u+b+b+bòabxý;ñx=u+b+b+b+bòrtsý;ñreturnñtoñcaller*ñ(ñañbñcñ--ñcñañbñ)fprrotòbsrófpswapô;ñañbñcñ--ñañcñbòleauò4,u÷;÷--ñañcñ(b)òbsrófpswapô;÷--ñcñañ(b)òleauò-4,uö;÷--ñcñañbòrts*ñ(ñañbñcñ--ñbñcñañ)fplrotòleauò4,u÷;ñañbñcñ--ñañbñ(c)òbsrófpswapô;÷--ñbñañ(c)òleauò-4,uö;÷--ñbñañcòbraófpswapô;÷--ñbñcña*ñ(ñañbñ--ñ)fp2dropòbsrófpdrop*ñbraófpdropô;ñfallñthrough*ñ(ñañ--ñ)fpdropòleauò4,uòrts*ñ(ñañbñ--ñbñañ)fpswapòlddó6,uòldxó2,uòstdó2,uòstxó6,uòlddó4,uòldxó,uòstdó,uòstxó4,uòrts*ñ(ñañbñ--ñbñ)fpnipòleaxò,uø;ñxñpointsñtoñbòleauò8,u÷;ñuñpointsñtoñaòbraófpldxõ;ñjustñloadñfromñx*ñ(ñañbñ--ñbñañbñ)fptuckòbsrófpswapô;ñañbñ--ñbña*ñbraófpoverô;õ--ñbñañbòSKIP2*ñ(ñañbñ--ñañbñañbñ)fp2dupòbsrófpoverô;ñcallñtwiceñfpover*ñbraófpoverô;ñbutñoptimized*ñ(ñañbñ--ñañbñañ)fpoveròleaxò4,u÷;ñpointñtoñ2ndñfltòSKIP2û;ñfldxñ(1ñbyteñgain)*ñ(ñañ--ñañañ)fpdupòleaxò,uø;ñmakeñxñpointñtoñtop*ñbraófpldxõ;ñofñstackñandñload*ñ=====================================*ñLoad/Storeñoperations*ñ=====================================*ñ(ñ--ñ@Xñ)òpushñfloatñatñXñontoñstackfpldxòlddó,xø;ñgetñexp+hiñmant.òldxó2,x÷;ñgetñlowñmantissaòpshuòd,xòrts*ñ(ñ--ñ@Sñ)ñcopyñfloatñfromñS-stackfpldsñMACROòpulsòd,x÷;ñpopñfloatñoutñofñSòpshuòd,x÷;ñpushñitñonñU-stackòENDM*ñ(ñfñ--ñ)ñcopyñfloatñontoñS-stackfpstsñMACROòpuluòd,xòpshsòd,xòENDM*ñ(ñfñ--ñ)ñcopyñfloatñtoñx,..,x+3fpstxòpuluòdù;ñgetñexpo+mant.òstdó,xø;ñstoreñatñxòpuluòdù;ñgetñmantòstdó2,x÷;ñstoreñatñx+2òrts*ñ(ñ--ñDñ)ñloadñañfloatñfromñDñ(unsignedfpldduòtstaü;ñD<256ñ?òbeqófpldbõ;ñyesñ=>ñldbñactually*ñ(ñ--ñDñ)ñloadñañfloatñfromñD!=0ñ(unsigfplddunzòpshuòcc,d,dpó;ñsetupñstackòlddó#$4100ô;ñfasterñthanñlda/clrbòstaó,uø;ñplaceñexponentñ($41)òstbó3,u÷;ñclearñlsbòrtsý;ñdone*ñ(ñ--ñ1ñ)fpld1òldbó#1òbraófpldbnz*ñ(ñ--ñBñ)ñloadñañfloatñfromñBñ(unsignedfpldbòtstbòbneófpldbnz*ñ(ñ--ñ0ñ)fpld0òclraòSKIP2*ñ(ñ--ñBñ)ñloadñañfloatñfromñB!=0ñ(unsigfpldbnzòldaó#$40ö;ñsignedñexpo=0òldxó#0ø;ñnoñfractñpartòpshuòd,xòrts*ñ(ñ--ñDñ)ñloadñañfloatñfromñDñ(signed)fplddòtstaòbeqófpldbõ;ñA=0ñ=>ñloadñBòbplófplddunzò;ñA>0ñ=>ñloadñD!=0ònegdü;ñA<0ñ=>ñD=-Dòbsrófpldduô;ñloadñDñunsignedòbraófpnegõ;ñnegateñresult*ñ(ñfñ--ñ)ñloadñD-regñwithñtrunc(f)*ñD=+/-$7FFFñinñcaseñofñoverflowfpstdòclraòldbó,uø;ñgetñexponentòlslbü;ñgetñridñofñsignñbitòDOIFòmiôcmpbò#$41*2ôDOIFòhiö;ñexpo>$41ñ=>ñoverfl.ölddò#$7FFFñ;ñmaxintôDOELSEöDOIFñeqølddó1,uñ;ñgetñDñfromñmant.öDOELSEøldbó1,uöDONEôDONEòDOELSEôclrbú;ñexpo<$40,f<1ñ=>ñD=0òDONEòtstò,uù;ñf<0?òDOIFòmiônegdú;ñyes=>negateñdòDONEòjmpófpdropô;ñdone*ñ=====================================*ñComparison:ñNñandñZñflagñupdated*ñsoñcompareñlikeñusigned*ñ=====================================*ñ(ñfñ--ñfñ)ñflagsñ=ñsign(f)fptstòldaó,uø;ñgetñexpoòlslaü;ñmoveñsign-bitñoffòDOIFòneø;ñf==0ñ?ôroraú;ñnoñ=>ñputñsignñbackòDONEòrtsý;ñdone*ñ(ñfñgñ--ñfñgñ)ñ=ñfptst(f-g)fpcmpòldaó4,uòeoraò,uø;ñsign(f)==sign(g)ñ?òDOIFòmiôldaó4,uõ;ñnoñ=>ñgetñfñexpoôbraófptst+2ñ;ñsign(f-g)==sign(f)òDOELSEôbsrócmpmagò;ñcompareñbyñmag,ñbutôtfrócc,bô;ñinvñorderñforñneg.ôldaó,uö;ñf<0ñ?ôDOIFòmiôeorbò#$08ô;ñyesñ=>ñinvñNñflagôDONEôtfrób,ccô;ñnoò=>ñNñunchangedòDONEòrts*ñ(ñfñgñ--ñfñgñ)ñ=ñfptst(abs(f)-abs(g))*ñcompareñnumñbyñmagnit.ñ(signñignored)cmpmagòldaó,uø;ñgetñnum1ñexpoòlslaü;ñremoveñsignòstaó,-sòlddó4,u÷;ñgetñnum2ñexpoñ+ñMSBòlslaü;ñremoveñsignòcmpaò,s+÷;ñsameñexpoñ?òDOIFòeqôcmpbò1,uõ;ñyes=>compareñMSBôDOIFòeqölddó6,uó;ñsameñMSB=>compñLSWösubdò2,uó;ñfasterñcmpdñ;)ôDONEòDONEòrts*ñ=====================================*ñArithmeticñoperations*ñ=====================================*ñ(ñfñ--ñfñ)fpabsòldaó#$7Fö;ñsign-bitñclearñmaskòandaò,uø;ñclearñsignñbitòbraófpstaõ;ñupdateñexponent*ñ(ñfñ--ñ-fñ)fpnegòldaó,uø;ñgetñexpoòeoraò#$80ö;ñinvertñsign-bitòbraófpstaõ;ñupdateñexponent*ñ(ñfñgñ--ñf-gñ)fpsubòbsrófpnegõ;ñx-yñ=ñx+(-y)*ñ(ñfñgñ--ñf+gñ)fpaddòDO*ñensureñfñisñbiggerñthanñgôbsrócmpmagò;ñfñ<ñgñ?ôDOIFòloöjsrñfpswapò;ñnoñ=>ñputñsmallerñfiôDONEôldaó,uö;ñgetñgñexpoôleauò4,uõ;ñprepareñstackôandaò#$7fô;ñg==0?ôbeqóEXITô;ñyesñ=>ñfinished*ñalignñgñmantissañwithñfñmantissaôsubaò,uö;ñnoñ=>ñcompareñmag.ôandaò#127ôDOIFòneöcmpaò#$7fò;ñ1ñorderñofñdiffñ?öDOIFòeqølddò-3,uñ;ñyesñ=>ñshiftñ1ñplaceøclrò-3,uñ;ñXXñYYñZZñ-->ñ0ñXXñYYöDOELSEøsubañ#$7eñ;ñ>2ñorderñofñdiffñ?øbneñEXIT3ñ;ñnoñ=>ñdoneøldbò-3,uñ;ñgetñXXøstaò-3,uñ;ñclearñMSB:ñ00ñYYñZZöDONEöstdó-2,uò;ñ00ñ00ñXXñorñ00ñXXñYYôDONE*ñcompareñsignñtoñseeñifñweñareñaddingño*ñsubtractingôldaó-4,uô;ñgetñsignñofñgôeoraò,uö;ñxorñwithñsignñofñfôDOIFòmi*ñsignñisñdifferent:ñdoñproperñdifferencölddó2,uó;ñgetñf-LSWösubdñ-2,uó;ñsub.g-LSWöstdó2,uó;ñstoreñresultöldaó1,uó;ñgetñf-MSBösbcaò-3,uò;ñsub.g-MSBñ/wñcarryöstaó1,uó;ñstoreñMSBöDOIFñeq*ñsubtractionñclearedñMSBølddñ2,uó;ñgetñLSWøbeqñfpstañ;ñyesñ=>ñresultñ=ñ0østdñ1,uó;ñleftñshiftñmantissaølddñ#$7F00ødecñ,uô;ñdecñexponentøandañ,uó;ñunderflow?øbeqñfpstañ;ñyes=>result=0østbñ3,uó;ñclearñLSBöDONEôDOELSE*ñsignñisñsame:ñdoñproperñadditionölddó2,uó;ñgetñf-LSWöadddñ-2,uó;ñaddñg-LSWöstdó2,uó;ñstoreñLSWölddó1,uó;ñgetñMSBñ(+ñmiddleñbyöadcaò-3,uò;ñaddñMSBöDOIFòcsô;ñMSBñoverfowñ?øincó,uò;ñyesñ=>ñincreaseñexpoøbeqófpovfñ;ñ11111111+1ñ=>ñovføbvsófpovfñ;ñ01111111+1ñ=>ñovføstdó2,uñ;ñshiftñLSWøldaó#1ò;ñputñcarryñinñMSBöDONEöstaó1,uó;ñupdateñMSBôDONEòDONEòrtsý;ñdone*ñ(ñfñ--ñ0ñ)fpclròclraü;ñmakeñresult=0fpstaòstaõ,uö;ñstoreña-regñtoñexpoòrts*ñ(ñfñ--ñ1/fñ)fpinvòjmpófpinv_vnrd*ñ(ñfñ--ñ10*fñ)ñfastfp_m10òjsrófpdupõ;ñ--ñfñfòbsrófpshlõ;ñ--ñfñf*2òbsrófpshlõ;ñ--ñfñf*4òjsrófpaddõ;ñ--ñf*5*òbraófpshlô;ñ--ñf*10ñFALLñTHROUGH*ñ(ñfñ--ñ2*fñ)ñfast!fpshlòldaó,uø;ñgetñexpoòlslaü;ñf==0ñ?òDOIFòneôlsló3,uõ;ñnoñ=>ñshiftñmant.ôroló2,uõ;ñ1ñbitñtoñtheñleftôroló1,uôDOIFòcsölddó1,uó;ñoverflowöstdó2,uó;ñrightñshiftñmant.öldaó#1ô;ñputñcarryñatñmsböstaó1,uöaddaò,uô;ñincreaseñexponentöbeqófpovfñ;ñ11111111ñ+1ñ==>ñovföbvsófpovfñ;ñ01111111ñ+1ñ==>ñovföstaó,uôDONEòDONEòrts*ñ(ñfñ--ñsign(f)*maxfltñ)fpovfòlddó#$ffffô;ñmakeñresultñ=ñ+/-ñmaòstdó2,u÷;ñmaxñLSWòlsraü;ñA=$7FFFòoraó,uø;ñinsertñsign-bitòstdó,uø;ñupdateñMSWòrts*ñ(ñfñ--ñf^2ñ)fpsqròjsrófpdupõ;ñduplicateñ&ñmulòSKIP2û;ñskipñoverñfpdiv*ñ(ñfñgñ--ñf/gñ)fpdivòbsrófpinvõ;ñf/gñisñf*(1/g)*ñ(ñfñgñ--ñf*gñ)fpmulòldaó,uø;ñgetñfñexponentòleauò4,u÷;ñupdateñstackñptròldbó,uø;ñgetñgñexponent*ñhandleñmulñbyñ0ñcaseòlslaü;ñf=0ñ?òbeqófpstaõ;ñyesñ=>ñresult=0òlslbü;ñg=0ñ?òbeqófpclrõ;ñyesñ=>ñresult=0*ñhandleñexponentsòsubaò#$80ö;ñunbiasñfñexponentòsubbò#$80ö;ñunbiasñgòexponentòstaó,-s÷;ñcomputeñexponentñaddòaddbò,s+÷;ñoverflowñ?òDOIFòvsôbmiófpovfó;ñyesñ&ñexpo>0ò=>ñmaxôbraófpclró;ñyesñ&ñexpo<=0ñ=>ñres*ñPartialñproductsñsumsñareñencodedñin*ñañtableñwhichñcontainsñpairsñof*ñoffsetsñ(a,b)ñwhichñisñreadñas*ñfollow:*òa>0ó=>ñaddña-offsetñ*ñb-offset*òa=b=0ñ=>ñshiftñpartialñproduct*òa<0ó=>ñdone**ñU-stackñrelativeñindices*ú1,ñ2,ñ3*ù-3,-2,-1*ñpartialñproducts*÷1*-3*ú2*-3*ý3*-3*ú1*-2*ý2*-2*ÿñ3*-2ô<==ñbootstrap*ý1*-1*ÿñ2*-1*ÿô3*-1ñ<==ñignoredñ(fifpmultbòfcbó2,-1,0,0òfcbó3,-3,2,-2,1,-1,0,0òfcbó2,-3,1,-2,0,0òfcbó1,-3òfcbó-1òDOELSEôaddbò#$80ô;ñaddñbias*ñhandleñmultiplicationñofñsignsôstbó,-sõ;ñsaveñexponentôldbó,uö;ñgetñfñexpoôeorbò-4,uô;ñxorñgñexpoôlslbú;ñputñsignñinñC-flagôldbó,s+õ;ñrestoreñexponentôrorbú;ñputñsign-bitñinôstbó,uö;ñupdateñresult'sñexp*ñdoñpartialñproductsôldaó3,uõ;ñbootstrapñwithñ3*-2ôldbó-2,uômulû;ñignoreñclrñ-6,-5ôstdó-8,uô;ñsinceñit'llñbeñdoneôclró-9,uô;ñbyñfutureñshifts.ôldxó#fpmultbôlddó,x++ô;ñgetñcodeôDOöDOIFòeq*ñcode=0ñ=>ñshiftølddò-7,uñ;ñcode=0ñ=>ñshiftøstdò-6,uølddò-9,uøstdò-8,uøclrò-9,uöDOELSE*ñcode>0ñ=>ñnextñpartialñproductøldaóa,uñ;ñnextñpartialñprod.øldbób,uømul÷;ñmultiplyñelementsøDOIFòneúadddò-8,uò;ñaddñtheñpartialústdó-8,uò;ñproductúDOIFòcsüincñ-9,uò;ñhandleñcarryúDONEøDONEöDONEölddó,x++*ñcode<0ñ=>ñexitñloopôWHILEñpl*ñcopyñresultñbackñtoñfloatôlddó-8,uô;ñgetñHIñvalueôtstaú;ñextrañbyteñneededñ?ôDOIFòneöstdó1,uó;ñyesñ=>ñshiftñresultöldbó-6,uò;ñfetchñlsböstbó3,uó;ñstoreñlsböldbó,uô;ñincreaseñexpo.öincbölslbölbeqòfpovföincó,uôDOELSEöstbò1,uô;ñnoñ==>ñwriteñMSBölddò-6,uó;ñgetñLSWöstdò2,uô;ñputñLSWôDONEòDONEòrtsý;ñdone*ñ(ñfñ--ñf/2ñ)ñfast!fpshròlddó,uø;ñgetñexponentñ+ñmsbòlslaü;ñnum==0ñ?òDOIFòneôlsrbú;ñrightñshiftñmsbôDOIFòeqölddó2,uó;ñrightñshiftñlswörordöstdó1,uó;ñputñitñinñmswöldaó#0ô;ñclearñlsböroraø;ñinjectñcarryöstaó3,uó;ñupdatedñlsbödecó,uô;ñdecr.ñexponentôDOELSEöstbó1,uó;ñplaceñMSBñbacköroró2,uó;ñshiftñrestñoföroró3,uó;ñmantissaôDONEòDONEòrts*ñ(ñfñgñ--ñfñ%ñgñ)fpmodòjsrófp2dupô;ñfñgñ--ñfñgñfñgòjsrófpdivõ;õ--ñfñgñf/gòjsrófpflooró;õ--ñfñgñfloor(f/gòjsrófpmulõ;õ--ñfñg*floor(f/gòjmpófpsubõ;õ--ñf-g*floor(f/g*ñ(ñfñgñ--ñfñremñgñ)fpremòjsrófptuckô;ñfñgñ--ñgñfñgòjsrófpdivõ;õ--ñgñf/gòbsrófpfracô;õ--ñgñfrac(f/g)òjmpófpmulõ;õ--ñg*frac(f/g)*ñ(ñfñ--ñsqrt(f)ñ)fpsqrtòjsrófpdupõ;ñfñ--ñfñfòjsrófpinvsqrtñ;ó--ñfñ1/sqrt(f)òjmpófpmulõ;ó--ñf*1/sqrt(f)*ñ(ñfñ--ñfrac(f)ñ)ñremoveñintegerñpart.*ñ(signñisñkept)fpfracòclrbü;ñpreloadñBñwithñ0òldaó,uø;ñgetñexponentòlslaü;ñgetñridñofñsignñbitòDOIFñmiù;ñf<1ñ=>ñdoneôcmpaò#$82ôbhsófpstbó;ñx>=256^3ñ=>ñretñ0ôlslaú;ñremoveñleadingñbitôDOIFñeqölddó2,uó;ñexpo=$40,ñgetñfractöbeqófpstbñ;ñfrac=0ñ=>ñretñ0östdó1,uó;ñshlñmantissañ1ñbyteöclró3,uó;ñclearñlsbödecó,uô;ñdecreaseñexponentörtsù;ñdoneôDONEôldbó3,uõ;ñexpo=$41ôbeqófpstbó;ñfrac=0ñ=>ñretñ0ôstbó1,uõ;ñshlñmant.ñ2ñbytesôlddó#0ö;ñclearñlsbñ&ñmsbôstdó2,uôldbó,uö;ñexponent=-2ôandbò#$80ô;ñkeepñsignôorbó#$3efpstbôstbó,uö;ñreturnñ0òDONEòrts*ñ(ñfñ--ñtrunc(f)ñ)ñremoveñfractionnalfptruncòclrbü;ñpreloadñBñwithñ0òldaó,uø;ñgetñexponentòlslaü;ñgetñridñofñsignñbitòbplófpstbõ;ñexpo<$40ñ=>ñretñ0òcmpaò#$82ö;ñf>=256^3ñ=>ñdoneòDOIFòlsôlslaú;ñexpo==0ñ($40)ñ?ôDOIFòeqöstbñ2,uõ;ñyesñ=>ñclearñmsb+ôDONEôstbó3,uõ;ñclearñlsbòDONEòrts*ñ(ñfñ--ñfloor(f)ñ)ñroundñtoñ-inffpflooròldaó,uòbplófptruncòjsrófpdupòjsrófptruncòjsróchkchgòDOIFòneôjsrófpld1ôjsrófpsubòDONEòrts*ñ(ñfñ--ñceil(f)ñ)ñroundñtoñ+inffpceilòjsrófpnegòbsrófpflooròjmpófpneg*ñ(ñfñ--ñround(f)ñ)ñroundñtoñnearestfproundòldxó#0òlddó#$8080òandaò,uòoraó#$3fòpshuòd,xòjsrófpaddòbraófptrunc*ñ(ñ--ñ2^nñ)ñnñisñD-regñ(signed)fp2todòDOôstaó,-sõ;ñsignñwillñbeñposôDOIFòplöpshsòdõ;ñpushñnöldbó#2ô;ñloadñ2öjsrófpldbnzôDOELSEöclró,sönegdø;ñnegadeñdöpshsòdõ;ñpushñ-nölddó#$3F80öldxó#$0ó;ñloadñ0.5öpshuòd,xôDONEòDOELSE*ñ(ñfñ--ñf^nñ)ñnñisñinñD-regñ(signed)fppowdôstaó,-sôDOIFòmiönegdø;ñnegateñ'n'ôDONEôpshsòd÷;ñsaveñnñonñstackòDONE*ñmainñpowerñalgorithmòjsrófpld1õ;ñ--ñfñg=1òlddó,sø;ñloadñnñfromñstackòDOôlsrdôstdó,sö;ñn=n/2ôDOIFòcsö;ñnñwasñodd:ñg'=fgöbsròfpovermulôDONEôfpstsù;ñpushñg/g'ñonñstackôjsrófpsqró;ñsquareñfôfpldsù;ñgetñg/g'ñbackôlddó,sö;ñloopñwhileñn!=0òWHILEñneòleasò2,s÷;ñfixupñstackòldaó,s+÷;ñwasñn<0ñ?òDOIFòmiôjsrófpinvó;ñyes=>result=1/resultòDONEòjmpófpnipõ;ñgetñridñofñf^2^...*ñ(ñfñ--ñ1/fñ)ñusingñ1/sqrt(f)fpinv_quakeòldaó,uø;ñgetñexpoñ&ñsignòandaò#$80ö;ñisolateñsignòstaó,-s÷;ñsaveñsignñonñstackòjsrófpinvsqrtñ;ñcomputeñ1/sqrt(f)òjsrófpsqrõ;ñ1/f=1/sqrt(f)^2òldaó,s+÷;ñgetñsignñbackòoraó,uø;ñinjectñinñresultòstaó,uòrts*ñ(ñfñ--ñ1/fñ)*ñhttps://en.wikipedia.org/wiki/Divisionfpinv_vnrdòldbó,uø;ñgetñexpoòlslbü;ñremoveñsignñbitòDOIFòeqø;ñf==0?ôjmpófpovfòDONEòrorbü;ñputñsignñbackòstbó,-sòandbò#127òstbó,uø;ñ--ñfòjsrófpnormô;ñ--ñgñnòjsrófpstdònegdòjsrófp2todô;ñ--ñgñ2^-nòldbó,s+òDOIFòmiôjsrófpnegòDONEòjsrófpswapô;ñ--ñ2^-nñgòjsrófpdupõ;ñ--ñ2^-nñgñgòldxó#fpinv_vnrd_tabòjsrófppolyòjsrófpswapô;ñ--ñ2^-nñxñgòbsrófpovermulñ;ñ--ñ2^-nñxñgxòjsrófpld1õ;ñ--ñ2^-nñxñgxñ1òjsrófpsubõ;ñ--ñ2^-nñxñgx-1=-eòjsrófp2dupô;ñ--ñ2^-nñxñ-eñxñ-eòjsrófpmulõ;ñ--ñ2^-nñxñ-eñ-ex=-yòjsrófpswapô;ñ--ñ2^-nñxñ-yñ-eòbsrófpovermulñ;ñ--ñ2^-nñxñ-yñe*yòjsrófpsubõ;ñ--ñ2^-nñxñ-y-e*yòjsrófpsubõ;ñ--ñ2^-nñx+y+yeòjmpófpmulõ;ñresultfpovermulòjsrófpoveròjmpófpmulfpinv_vnrd_tabòfdbó$4002,$95FBó;ñ256/99òfdbó$C005,$D174ó;ñ-64/11òfdbó$4004,$3E10ó;ñ140/33òfcbó$80*ñ(ñfñ--ñ1/fñ)*ñhttps://en.wikipedia.org/wiki/Divisionfpinv_goldschmidtòldbó,uø;ñgetñsignòlslbü;ñremoveñsignñbitòDOIFòeqø;ñf==0?ôjmpófpovfòDONEòrorbü;ñputñsignñbackòstbó,-sòandbò#127òstbó,uø;ñ--ñfòjsrófpnormô;ñ--ñgñnòjsrófpstdònegdòjsrófp2todô;ñ--ñgñ2^-nòldbó,s+òDOIFòmiôjsrófpnegòDONEòjsrófpswapô;ñ--ñ2^-nñgòjsrófpld1õ;ñ--ñ2^-nñgñ1òjsrófpsubõ;ñ--ñ2^-nñg-1òjsrófpnegõ;ñ--ñ2^-nñ1-g=xòjsrófpswapô;ñ--ñxñ2^-n=hòDOôjsrófpoverò;ñxñhñxôjsrófpld1ó;ñxñhñxñ1ôjsrófpaddó;ñxñhñx+1ôlddó2,uõ;ñx+1==1ñ?ôbeqóEXITô;ñyesñ=>ñdoneôjsrófpmuló;ñxñh'=h(x+1)ôfpstsù;ñxñ(h')ôjsrófpsqró;ñx^2ñ(h')ôfpldsù;ñx^2ñh'òWHILEñraòjsrófpdropô;ñxñhòjmpófpnipõ;ñh*ñ=====================================*ñtranscendentalñfunctions*ñ=====================================*ñ(ñfñ--ñ1/sqrt(abs(f))ñ)*ñiteratesñg=g*(1.5ñ-ñf*g*g)fpinvsqrtòlddó,uø;ñgetñexpoñ+ñMSBòoraó#$80ö;ñmakeñf<0òcmpaò#$80ö;ñisñf==0ñ?òDOIFñeqôjmpófpovfó;ñyesñ=>ñoverflowòDONEòstaó,uø;ñ--ñ-f*ñprepareñ1stñapproxñofñ1/sqrt(x)ñfromñMòbitbò#%11110000òDOIFòneôbitbò#%11000000ôDOIFòneöldbó#16ó;ñ16ñforñ64<=msbôDOELSEöldbó#32ó;ñ32ñforñ16<=msb<64ôDONEòDOELSEôbitbò#%00001100ôDOIFòneöldbó#64ó;ñ64ñforñ4<=msb<16ôDOELSEöldbó#128ò;ñ128ñforñ1<=msb<4ôDONEòDONE*ñWeñshouldñdo:*ñandañ#$7Fñsubañ#$40ñasraõcomaòadd*ñ01xxxxxxñ00xxxxxxñ000xxxxxñ111yyyyyñ00*ñ00xxxxxxñ11xxxxxxñ111xxxxxñ000yyyyyñ01*ñTheñfollowingñdoesñtheñsameñresultñbut*ñshorterñ(outputñcarryñisñonñifñtheñexp*ñwasñodd)òlslaü;ñ1xxxxxx0ñ0xxxxxx0òasraü;ñ11xxxxxxñ00xxxxxxòlsraü;ñ011xxxxxñ000xxxxxòeoraò#%01011111ñ;001yyyyyñ010yyyyyòDOIFòcsôlsrbú;ñoddñexpoñ=>ñdivideôlsrbú;ñapproxñbyñ256^0.5ôlsrbôlsrbòDONEòpshsòdù;ñpushñapproxñ1/sqrtòpshsòdù;ñontoñsñstackòjsrófpshrõ;ñ--ñ-f/2òfpldsû;ñ--ñ-f/2ñgòDOôjsrófp2dupò;ñ-f/2ñgñ-f/2ñgôjsrófpsqró;ñ-f/2ñgñ-f/2ñg*gôjsrófpmuló;ñ-f/2ñgñ-f*g*g/2ôldxó#$8000ôlddó#$4001ôpshuòd,xõ;ñ-f/2ñgñ-fgg/2ñ1.5ôjsrófpaddó;ñ-f/2ñgñ1.5-fgg/2ôjsrófpoverò;ñ-f/2ñgñ1.5-fgg/2ñyôjsrófpmuló;ñ-f/2ñgñg(1.5-fgg/2)ôbsróchkchgò;ñ-f/2ñg*(1.5-fgg/2)òWHILEñneòjmpófpnip*ñ(ñañbñ--ñbñ)ñZ=1ñiffña==bchkchgòpuluòd,x÷;ñgetñHI/LOòDOôcmpdò,uö;ñHI(a)==HI(b)ñ?ôbneóEXITô;ñnoñ=>ñgotoñelseôcmpxò2,uõ;ñLO(a)==LO(b)ñ?ôbneóEXITô;ñnoñ=>ñgotoñelseòDOELSEôstdó,uö;ñcopyñHIôstxó2,uõ;ñcopyñLOôldaó#1ö;ñforceñZ=0òDONEòrts*ñ(ñfñ--ñgñnñ)ñgivenñanñf,ñreturn*ñañnumberñg=f/2^nñsuchñthat*ñ0.5<=g<1fpnormòldbó,uø;ñgetñexponantòandbò#127ö;ñremoveñsign-bitòDOIFòeqôjmpófpld0ó;ñf==0?ñg=f,n=0.ñdoneòDONEòsubbò#$3fö;ñremoveñbias-1òsexý;ñextendñsignñtoñaòlsldü;ñmulñbyñ8òlsldòlsldòpshsòyù;ñpreserveñregòtfród,y÷;ñnowñusesñyñasñnòldaó,uòandaò#$80ö;ñpreserveñsignòoraó#$3fö;ñmakeñ1/256<=f<1òstaó,uòldaó1,uòDOIFòmi*ñfñalreadyñ>=ñ0.5òDOELSEôjsrófpshló;ñmulñbyñ2ôleayò-1,yô;ñdecreaseñnñbyñoneôldaó1,uõ;ñloopñwhileñf<.5òWHILEñplòtfróy,d÷;ñputñnñtoñdòpulsòyù;ñrestoreñregòjmpófplddõ;ñpushñdñontoñstack*ñ(ñfñ--ñP(f)ñ)ñevalñañpolynomñusing*ñhornerñmethod.ñcoefsñareñpointedñby*ñx.ñCoefsñstopsñatñ$80.fppolyòpshsòyòleayò4,xòjsrófpldxõ;ñ--ñfñg=0òDOôjsrófpoverò;ñ--ñfñgñfôjsrófpmuló;ñ--ñfñg*fôleaxò,yôjsrófpldxó;ñ--ñfñg*fñcoefôjsrófpaddó;ñ--ñfñg*f+coefôleayò4,yõ;ñadvanceñyôldbó,yö;ñcoef==sentinelñ?ôcmpbò#$80ô;ñno=>loopòWHILEñneòpulsòyòjmpófpnipõ;ñfñP(f)ñ--ñP(f)*ñ(ñfñ--ñln(f)ñ)ñnaturalñlogarithm**ñln(f)ñ=ñln(f/2^n)ñ+ñn*ln(2)**ñWhenñ0.5<=x<=1*ñ65536*ln(x)*ò=ñ-183520ñ+ñx*(*õ555367ñ+ñx*(*ô-970648ñ+ñx*(*ô1194335ñ+ñx*(*ô-920804ñ+ñx*(*õ399960ñ+ñx*(*õ-74690))))))*ñ+/-ñ0.24422799601597944*ñ(determinedñbyñRemezñalgorithm)*fplnòldbó,uø;ñf<=0ñ?òDOIFòlsôlddó#$ffffò;ñyesñ=>ñoverflowôstdó,uö;ñreturnñ-MAXôstdó2,uôrtsòDONEòbsrófpnormô;ñ--ñg=f/2^nñnòlddó#$3fB1òldxó#$7218òpshuòd,x÷;ñ--ñgñnñln(2)òjsrófpmulõ;ñ--ñgñn*ln(2)òjsrófpswapô;ñ--ñn*ln(2)ñgòldxó#fplntabòbsrófppolyô;ñ--ñn*ln(2)ñP(g)òjmpófpaddõ;ñ--ñn*ln(2)+Pfplntabòfdbó$C001,$23C2òfdbó$4006,$1A58òfdbó$C00E,$0CE4òfdbó$4012,$395Fòfdbó$C00E,$CF98òfdbó$4008,$7967òfdbó$C002,$CCE0òfcbó$80*ñ(ñfñgñ--ñf**gñ)fppowôjsrófpswapô;ñ--ñgñfôbsrófplnö;ñ--ñgñln(f)ôjsrófpmulõ;ñ--ñg*ln(f)*óbraófpexpõ;ñ--ñexp(g*ln(f))*ñ(ñfñ--ñexp(x)ñ)*ñComputationñisñdoneñusingñthese*ñlines:*óexp(f)ñ=ñ1/exp(-f)ñifñf>0**ófiõ=ñtrunc(f)*óffõ=ñfrac(ff)*ófö=ñfiñ+ñff*óexp(f)ñ=ñexp(fi)*exp(ff)*ú=ñexp(1)**fiñ*ñexp(ff)**ñexp(ff)ñisñinterpolatedñfrom*ñthisñoptimalñdegreeñ4ñpolynomial*ñfoundñbyñtheñRemezñalgorithm:*ñ0.9999900075045562ñ+*ñ0.9994830981718971ñxñ+*ñ0.4957031523076224ñx^2ñ+*ñ0.15396347835734295ñx^3ñ+*ñ0.025642850383947424ñx^4*ñerrorñisñ0.00000999249547650738*ñonñtheñ-1..0ñinterval*ñ(foundñviañtheñRemezñalgo)fpexpòldbó,uø;ñgetñsignòstbó,-s÷;ñsaveñitñonñstackòorbó#$80òstbó,uø;ñforceñfñ<ñ0òlddó#$4002ô;ñpushñe=exp(1)òldxó#$B7E1òpshuòd,x÷;ñ--ñfñeòjsrófpoverô;ñ--ñfñeñf*ñjsrófptruncó;ñ--ñfñeñfiòjsrófpstdõ;ñD=trunc(-f)òjsrófppowdô;ñ--ñfñe**fiòjsrófpswapô;ñ--ñe**fiñfòjsrófpfracô;ñ--ñe**fiñffòldxó#fpexptabòjsrófppolyô;ñ--ñe**fiñe**ffòjsrófpmulõ;ñ--ñe**(fi+ff)=e**fòldbó,s+÷;ñgetñsignñbackòDOIFòplôjmpófpinvó;ñexp(f)=1/exp(-f)òDONEòrtsfpexptabòfdbó$3f06,$9088òfdbó$3f27,$6A27òfdbó$3f7E,$E667òfdbó$3fFF,$DE20òfdbó$3fFF,$FF58òfcbó$80*ñ(ñfñ--ñtan(f)ñ)ñtan(x)=sin(x)/cos(x)fptanòjsrófpdup÷;ñ--ñfñfòbsrófpsin÷;ñ--ñfñsin(f)òjsrófpswapö;ñ--ñsin(f)ñfòbsrófpcos÷;ñ--ñsin(f)ñcos(f)òjmpófpdiv÷;ñ--ñsin(f)/cos(f)*ñ(ñfñ--ñcos(f)ñ)ñcos(x)=sin(pi/2-x)fpcosòjsrófpneg÷;ñ--ñ-fòldxó#$9220òlddó#$4001òpshuòd,xù;ñ--ñ-fñpi/2òjsrófpadd÷;ñ--ñpi/2-fòbraófpsin÷;ñ--ñcos(f)*ñ(ñfñ--ñsin(f)ñ)*ñforñx=0..0.25,*ñsin(x*2pi)ñ=*ñ0.00000706851696623261ñ+*ñ6.28123666831557ñxñ+*ñ0.08660443020176666ñx^2ñ+*ñ-42.72388709496302ñx^3ñ+*ñ9.503048902548244ñx^4ñ+*ñ56.03072727906933ñx^5*ñ+/-ñ0.000007068527967724059fpsinòldbó,uø;ñgetñsignòstbó,-s÷;ñsaveñitñonñstackòandbò#$7Fòstbó,uø;ñforceñfñ>=ñ0òldxó#$BE61òlddó#$3f28òpshuòd,x÷;ñ--ñfñ1/(2pi)òjsrófpmulõ;ñ--ñf/(2pi)òjsrófpfracô;ñ--ñg=f/(2pi)%1òjsrófpld1õ;ñ--ñgñ1.0òjsrófpshrõ;ñ--ñgñ0.5òjsrócmpmagô;ñfñ>ñpiñ?òDOIFòhsôjsrófptuckò;ñ--ñ0.5ñgñ0.5ôjsrófpsubó;ñ--ñ0.5ñg-0.5ôjsrófpswapò;ñ--ñg-0.5ñ0.5ôcomó,sö;ñsin(f)ñ=ñ-sin(f-pi)òDONEòjsrófpshrõ;ñ--ñgñ0.25òjsrócmpmagô;ñfñ>ñpi/2ñ?òDOIFòlsôjsrñfpdropô;ñnoñ=>ñnoñchangeòDOELSEôjsrófpshló;ñ--ñgñ0.5ôjsrófpsubó;ñ--ñg-0.5ôldbó,uö;ñg-0.5<0ñ?ôDOIFòmiö;ñsin(f)=-sin(f)öcomó,sô;ñyesñ=>ñnegateñsignôDONEôandbò#$7Fô;ñ--ñfôstbó,uö;ñforceñfñ>=ñ0òDONEòldxó#fpsintabòjsrófppolyô;ñapproxñsinòldbó,s+÷;ñf<0òDOIFòmiôjmpófpnegó;ñsin(-x)=-sin(x)òDONEòrtsfpsintabòfdbó$4038,$07DEòfdbó$4009,$80C8òfdbó$c02A,$B951òfdbó$3f16,$2BB5òfdbó$4006,$47FFòfdbó$3d76,$970Dñ;ñfdbó$0000,$0000òfcbó$80*ñ(ñfñ--ñatan(f)ñ)*ñatan(x)ñ=ñpi/2ñ-ñatan(1/x)ñifñx>1*ñatan(x)ñ=*ñ0.000006389295356454743ñ+*ñ0.9993823248162877ñxñ+*ñ0.009671651742441202ñx^2ñ+*ñ-0.38851065034559806ñx^3ñ+*ñ0.1385076598650844ñx^4*ñ0.06582297699392516ñx^5*ñ-0.03948857839169288ñx^6*ñ+/-ñ0.0000063894644751760765*ñ0<=x<1fpatanòldbó,uø;ñgetñfñexponentòstbó,-s÷;ñstoreñitñonñstackòandbò#127ö;ñmakeñf>0òstbó,uø;ñ--ñfòlslbü;ñf>=1ñ?òDOIFòmiôjsrófpinvó;ñyesñ==>ñf=1/fòDONEòldxó#fpatantabòjsrófppolyô;ñf<1ñ:ñevalñpolyòldbó,sø;ñgetñorigñexpoòlslbü;ñf>=1ñ?òDOIFòmiôbsrófppiô;ñ--ñatan(f)ñpiôjsrófpshró;ñ--ñatan(f)ñpi/2ôjsrófpsubó;ñ--ñatan(f)-pi/2ôcomó,sö;ñchangeñresultñsignòDONEòldbó,s+÷;ñgetñsignñbackòDOIFòmiôjmpófpnegó;ñ--ñ-atan(f)òDONEòrtsfpatantabòfdbó$bf0A,$1BECòfdbó$3f10,$D9C6òfdbó$3f23,$753Dòfdbó$bf63,$756Fòfdbó$3f02,$79D7òfdbó$3fFF,$D785òfdbó$3d6B,$31D1òfcbó$80*ñ(ñ--ñpiñ)fppiòldxó#$243Fòlddó#$4003òpshuòd,xòrts*ñ(ñ--ñrndñ)ñ0ñ<ñrndñ<1ñperiod:65535*ñhttp://www.retroprogramming.com/2017/0fprndòlddó#0òVARóFPSEED,2òDOIFòeqôlddótimeCtôoraó123òDONE*ñxsñ^=ñxsñ<<ñ7òpshsòdù;ñsaveñxsòlsraü;ñshiftña0ñintoñb7òrorbü;ñb=hi(xs<<7)òeorbò,sø;ñlo(xs<<7)=carry*128òstbó,sø;ñhi(xs)^=hi(xs<<7)*ñxsñ^=ñxsñ>>ñ9**ñtrickyñpart:ñputñcarryñback*ñinñhi(xs>>9)ñsoñthatñitñis*ñsameñasñifñitñwasñintroduced*ñinñlo(xs)ñabove.òrorbü;ñb=hi(xs>>9)^lo(xs)òeorbò1,s÷;ñlo(xs)ñ^=ñhi(xs>>9)*ñxsñ^=ñxsñ<<ñ8;òtfrób,a÷;ñhi(xs<<8)òeoraò,s++ö;ñhi(xs)ñ^=ñhi(xs<<8)òstdóFPSEEDòjsrófpldduòdecó,uòdecó,uòrts*ñ(ñfñ--ñgamma(f+1)ñ)ñapproximate*ñfactorialñviañRamanujanñformulafpgammap1òlddó#$4001òldxó#$C5C0òpshuòd,x÷;ñ--ñfñsqrt(pi)òjsrófpoverô;ñ--ñfñsqrt(pi)ñfòjsrófpdupõ;ñ--ñfñsqrt(pi)ñfñfòlddó#$3F5Eòldxó#$2D59òpshuòd,x÷;ñ--ñfñsqrt(pi)ñfñfñ1/òjsrófpmulõ;ñ--ñfñsqrt(pi)ñfñf/eòjsrófpswapô;ñ--ñfñsqrt(pi)ñf/eñfòjsrófppowõ;ñ--ñfñsqrt(pi)ñ(f/e)*òjsrófpmulõ;ñ--ñfñsqrt(pi)*(f/e)*òjsrófpswapô;ñ--ñsqrt(pi)*(f/e)**fòldxó#fpgammap1tabòjsrófppolyô;ñ--ñsqrt(pi)*(f/e)**fòlddó#$3F2Aòldxó#$AAABòpshuòd,xòjsrófppowõ;ñ--ñsqrt(pi)*(f/e)**fòjmpófpmulõ;ñ--ñsqrt(pi)*(f/e)**ffpgammap1tabòfdbó$4008,$0000òfdbó$4004,$0000òfdbó$4001,$0000òfdbó$3F88,$8889òfcbó$80*ñ=====================================*ñread/write*ñ=====================================*ñ(ñ--ñ<parsedñfloat>ñ)ñx=stringñptr*ñuponñreturn,ñxñisñafterñlastñreadñcharfprdxòpshsòyù;ñpreserveñyòleayò,xø;ñtransferñxñtoñyòbsrófprdyõ;ñcallñreadingñfromñyòleaxò,yø;ñtrasnferñyñtoñxòpulsòy,pcö;ñrestoreñyñ&ñreturn*ñ(ñ--ñ<parsedñfloat>ñ)ñy=stringñptr*ñuponñreturn,ñyñisñafterñlastñreadñcharfprdyòbsrófprdiõ;ñreadñintegerñ--ñn*ñreadñdecimalñpartòldbó,yòcmpbò#'.÷;ñanyñdecimalñpoint?òDOIFòeqôjsrófpld0ó;ñyesñ==>ñparseñfract.ôjsrófpld1ó;ñ--ñ0ñ1ôDOöjsròfpdot1ñ;ñ--ñfractñE-n+1ñ0.1öjsròfpmulò;ñ--ñfractñE-nöleayñ1,yô;ñadvanceñptröldbò,yõ;ñreadñnextñcharösubbñ#'0ô;ñ<ñ'0'ñ?öbloòEXITó;ñyesñ=>ñdoneñparsingöcmpbñ#10ô;ñ>ñ'9'ñ?öbhsòEXITó;ñyesñ=>ñdoneñparsingöjsròfpldbò;ñ--ñfractñE-nñböjsròfpoverñ;ñ--ñfractñE-nñbñE-nöjsròfpmulò;ñ--ñfractñE-nñb.E-nöjsròfplrotñ;ñ--ñE-nñb.E-nñfractöjsròfpaddò;ñ--ñE-nñfract'öjsròfpswapñ;ñ--ñfract'ñE-nôWHILEñraôjsrófpdropò;ñ--ñxñfractôldaó4,uõ;ñgetñsignñofñxôandaò#$80ô;ñisolateñsignñbitôoraó,uö;ñcombineñwithñfractôstaó,uö;ñmakeñfractñandñxñsamôjsrófpaddó;ñ--ñx.fractôldbó,yö;ñgetñnxtñcharòDONE*ñreadñexponentòDOôcmpbò#'eõ;ñanyñexponentñsignñ?ôbeqóEXITô;ñyesñ==>ñgotoñELSEôcmpbò#'EôbeqóEXITòDOELSEôleayò1,yõ;ñadvanceôldbó#10ôjsrófpldbnzñ;ñ--ñx.fractñ10ôbsrófprdió;ñ--ñx.fractñ10ñexpoôjsrófpstdó;ñ--ñputñexpoñinñDôjsrófppowdò;ñ--ñx.fractñ10^expoôjmpófpmuló;ñx.fract*10^expoòDONEòrts*ñ(ñ--ñ<parsedñint>ñ)ñy=stringñptr*ñuponñreturn,ñyñisñafterñlastñreadñcharfprdiòjsrófpld0õ;ñ0òldbó,y+÷;ñgetñsign-charòsubbò#'-òstbó,-s÷;ñpushñ0ñifñminusòDOIFòneôcmpbò#'+-'-ò;ñnon-nulñotherwiseôbeqóEXITôleayò-1,yòDONEòDOôldbó,y+õ;ñreadñnextñcharôsubbò#'0õ;ñ<ñ'0'ñ?ôbloóEXITô;ñyesñ=>ñdoneñparsingôcmpbò#10õ;ñ>ñ'9'ñ?ôbhsóEXITô;ñyesñ=>ñdoneñparsingôjsrófpldbó;ñ--ñnñdigitôjsrófpswapò;ñ--ñdigitñnôjsrófp_m10ò;ñ--ñdigitñ10*nôjsrófpaddó;ñ--ñ10*nñ+ñdigitòWHILEñraòleayò-1,yö;ñcompensateñforñ,y+òldbó,s+÷;ñgetñsignòDOIFòeqôjmpófpnegó;ñwasñnegativeñ=>ñnegòDONEòrts*ñ(ñañ--ñ)ñwriteñfloatingñpointñin*ñengineeringñnotationñinñstringñatñx*ñ(updated).fpwrxòpshsòyù;ñlocallyñuseñyñasòleayò,xø;ñstringñptròbsrófpwryòleaxò,yòpulsòy,pcfpwryòldaó,uø;ñgetñsignòlslaü;ñnum==0ñ?*ñzero-caseòDOIFñeqôldaó#'0õ;ñyesôstaó,y+õ;ówriteñ0.ñdone.òDOELSE*ñnegativeñcaseôDOIFñcsöldbñ#'-õ;ñnegñnumberöstbñ,y+õ;ñwriteñnegñsignôDONEôlsraú;ñmakeñnumñpositiveôstaó,uö;*ñcomputeñdecimalñexponent:*ñ==ñañ*ñln(256)/ln(10)*ñ~~ñañ*ñ154/64ôsubaò#$40ô;ñremoveñbiasôstaó,-sõ;ñsaveñexponentñsignôDOIFòmiônegaú;ñmakeñexponentñ>ñ0ôDONEôldbò#77*2ô;ñ/64ñisñhigh(d<<4)ômulôlsldôlsldôstaó,-sõ;ñsaveñdecimalñexp*ñcomputeñ1/10^(signedñdecimalñexpo)ôldbó1,sõ;ñgetñsignôDOIFòplöbsròfpdot1ñ;ñexpo>0ñuseñ0.1ôDOELSEöldbò#10ô;ñexpo<0ñuseñ10öjsròfpldbnzôDONEôclraú;ñbuildñpositiveñexpoôldbó,sôjsrófppowdò;ñ.1^(sign.ñdec.ñexpo)*ñmakeñnumñ"normalized"ñbetweenñ1ñandñ25ôjsrófpmulôbsrófpwrnorm*ñprintñdigitsñbeforeñdecimalñplaceôldbó1,uõ;ñgetñ1stñbigñdigitôclraú;ñnoñleadingñ0ôbsrófpwrbó;ñwriteñit*ñhandleñdecimalsñifñanyôlddó2,uõ;ñanyñfract.ñvalueñ?ôDOIFòneöldbó#'.ó;ñyesñ=>ñwriteñwithöstbó,y+ó;ñ4ñdecimalñplacesöbsrófpwrnxt2öbsrófpwrnxt2ôDONE*ñprintñexponentñifñnotñnulôpulsòd÷;ñgetñexponentñ&ñsignôtstaú;ñexpo==0ñ?ñnoñprintôDOIFòneötstbø;ñsetupñexpoñsignöDOIFòmiøldbñ#'-öDOELSEøldbñ#'+öDONEöstbó1,yó;ñstoreñsignñmarköldbó#'Eó;ñwriteñEñmarköstbó,y++ò;ñskipñoverñsignötfróa,böclraø;ñnoñleadingñ0ñpleaseöjsrófpwrbñ;ñwriteñexpoôDONEòDONEòclró,yø;ñendñofñstringòjmpófpdropô;ñfixñstack*ñ(ñ--ñ0.1ñ)fpdot1òlddó#$3f19òldxó#$999aòpshuòd,xòrts*ñextractñandñwriteñnextñ2ñfractionnal*ñdigitsñ(ifñany)fpwrnxt2òbsrófpwrnxtó;ñfallñthrough!*ñextractñandñwriteñnextñfractionnal*ñdigitñ(ifñany)fpwrnxtòlddó2,u÷;ñanyñfractionnalñ?òDOIFòneôclró1,uõ;ñclearñintñvalueôjsrófp_m10ò;ñgetñnxtñdigitôldbó1,uõ;ñgetñnextñdigitôaddbò#'0õ;ñconvertñtoñasciiôstbó,y+õ;ñupdateñstringòDONEòrts*ñmakeñnumñhaveñexpo==0,ñfixingñdecimalfpwrnormòDOôldbó,uö;ñgetñbiasedñexpoôcmpbò#$40ô;ñsigned-expoñ<=ñ0ñ?ôblsóEXITô;ñyesñ=>ñdoneôbsrófpdot1ôjsrófpmuló;ñnoñ=>ñdivideñbyñ10ôldbó3,sõ;ñandñupdateñdec.ñexpôDOIFòplöincó2,só;ñ+1ñifñ>0ôDOELSEödecó2,só;ñ-1ñifñ<0ôDONEòWHILEñraòDOôldbó,uö;ñ1ñ<=ñnumñ<ñ256ñ?ôcmpbò#$40ôbhsóEXITô;ñyesñ=>ñdoneôjsrófp_m10ò;ñnoñ=>ñmulñ10ôldbó3,sõ;ñandñupdateñdec.ñexpôDOIFòplödecó2,só;ñ-1ñifñ>0ôDOELSEöincó2,só;ñ+1ñifñ<0ôDONEòWHILEñraòrts*ñwriteñbñinñdecimalñtoñstringñpointed*ñbyñy.ñIfña!=0,ñthenñleadingñ0ñare*ñadded.fpwrbòpshsòdù;ñprepareñstack:òclraü;ñlead0-flag,ñ$00òstaó1,s÷;òlslbü;ñgetñb'sñmsbitòincbü;ñinjectñsentinelòDOôstaó,-sõ;ñrotateñAñwithñcarryôadcaò,s+ôdaaû;ñmakeñitñdecimalôroló1,sõ;ñrotateñ1stñdigitôlslbú;ñrotateñbòWHILEñneòldbó,sø;ñloadñlead0ñflagòorbó1,s÷;ñcombineñwithñdigitòDOIFòneôstbó,sö;ñifñnonñzero,ñprintsôldbó1,sõ;ñensureñflagñisñ!=0ôaddbò#'0õ;ñtoñwriteñallñdigitsôstbó,y+õ;ñandñwriteñ1stñdigitòDONEòstaó1,s÷;ñsaveñdigitsñ2ñ&ñ3òandaò#$F0ö;ñisolateñ2ndñdigitòoraó,sø;ñcombineñwithñlead0òDOIFòneôldaó1,sõ;ñifnñ0ñ=>ñwriteñitôldbó#$10ô;ñA<<4ñfasterñthanômulû;ñwithñrotationsôaddaò#'0ôstaó,y+òDONEòldaó1,s÷;ñgetñlastñ2ñdigitsòandaò#$0Fö;ñisolateñ3rdñdigitòaddaò#'0÷;ñconvertñtoñasciiòstaó,y+÷;ñwriteñitòpulsòd,pcö;ñrestoreñstack,ñdone*ñ=====================================*ñinteractiveñcalculator*ñ=====================================mainòpshsòd,x,y,u,dp,ccòldbó$6073õ;ñbackupñbuzzòpshsòbòclró$6073õ;ñdisableñbuzzòjsrótimeInitò;ñinitñtimeròlduó#fpstackò;ñsetupñfpuñstackòldxó#welcomeò;ñprintsñwelcomeòjsróputsö;ñmessageòincbü;ñflagñinterpreteròstbórunningòDOôbsróprPromptôldxó#inpbufôldyó#inpendôjsrógetsôDOöjsrónxtTokenöldbó,xöbeqóEXITò;ñnoñmoreñtokensöbsrófindCmdöldbó,yöDOIFòmiøbsrñtryFltò;ñnoñcmdñ=>ñtryñfloaöDOELSEøjsrñdoExecò;ñgotñcmdñ=>ñexecöDONEôWHILEñraôldbórunningòWHILEñneòpulsòbòstbó$6073òjsrótimeExitòldxó#byeòjsróprintlnòpulsòd,x,y,u,dp,ccòswiòrts*ñbuildñañnnn>ñprompt.ñnnnñrepresenting*ñrepresentingñcurrentñstackñdepthprPromptòldxó#outbufó;ñmakeñx&yñpointòleayò,xø;ñtoñoutputñbufferòjsróstksizeó;ñgetstackñsizeòoraó#255ö;ñprintñleadingñ0sòjsrófpwrbõ;ñwriteñnnnnòlddó#32+256*'>òstdó,y++ö;ñaddñ'>ñ'òclró,yø;ñendñofñstringòjmpóputsö;ñprintñprompt*ñtryñparsingñañfloatñatñstringñpointed*ñbyñxtryFltòjsrófprdxõ;ñreadñfloatòldbó,xø;ñgetñlastñunreadñcharòcmpbò#32÷;ñ<='ñ'ñ?òDOIFòlsôrtsû;ñyesñ=>ñdoneòDONEòjsrófpdropòldyó#syntaxErrò;ñred*ñbraóprErroró;ñprintñsyntaxñerror*ñprintsñtheñerrorñmessageñpointedñby*ñy.ñThenñprintñtheñcurrentñtoken*ñ(pointedñbyñx).ñThenñmakeñxñpointñto*ñendñofñstringñtoñstopñexecutingñany*ñotherñcommandñinñtheñbuffer.prErroròclrótimeEnô;ñclearñtimingñflagòexgóx,yòjsróputsö;ñprintsñerrorñmsgòDOôldbó,y+õ;ñadv.ñtoñnextñtokôcmpbò#32õ;ñendñofñtokñreached?ôblsóEXITô;ñyesñ=>ñquitôjsróputcô;ñnoñ=>ñprintñtokñchròWHILEñraòtstbü;ñendñofñstring?òDOôbeqóEXITô;ñyesñ=>ñexitñloopôldbó,y+õ;ñgetñnextñcharòWHILEñraòleaxò-1,yö;ñmakeñxñpointñtoñ0òjsróprintlnó;ñprintsñcrlfòleaxò-1,yö;ñmakeñxñpointñtoñ0òrts*ñgivenñañstringñpointedñbyñx,ñfindCmd*ñañcmdñdescriptorñ(pointedñbyñy)ñwhich*ñmatchñtheñcurrentñtokenñstartedñatñx.*ñIfñañcmdñisñfoundñthenñ",y"ñcontains*ñtheñarityñ(numberñofñrequiredñparams*ñonñstack)ñforñtheñcommand,ñandñ"1,y"*ñcontainsñtheñexecutionñadressñofñthe*ñcmd.ñIfñnoñcmdñmatches,ñthenñ"1,y"*ñcontainsñ-1.findCmdòldyó#cmdsõ;ñloadñcommandñdesc.òDOôpshsôxõ;ñsaveñtokenñptrôDOöldbó,xô;ñgetñnextñcharöcmpbò#32öblsóEXITò;ñnoneñ=>ñdoneñloopöDOøcmpbò#'Añ;ñmakeñlowerñcaseøbloóEXITøcmpbò#'ZøbhióEXITøaddbò#'a-'AöDONEöcmpbò,yô;ñcmpñwithñcurröbneóEXITò;ñcmd.ñnoñmatch=>nextöleaxò1,xó;ñmatch:ñadvanceñbothöleayò1,yó;ñpointersôWHILEóraôDOöldbó,xô;ñinputñtokenñfullyöcmpbò#32ó;ñreadñ?öbhióEXITò;ñnoñ=>ñtryñnextñcmdöldbó,yô;ñcurrñcmdñsymbolöcmpbò#10ó;ñfullyñread?öbhsóEXITò;ñnoñ=>ñtryñnextñcmdöstxó,sô;ñcmdñfound!ñreturnñxöpulsòx,pcò;ñstackñfixup&ereturnôDONEôpulsôxõ;ñresetñinputñptrôDOöldbó,y+ó;ñreadñwholeñcmdöcmpbò#10ó;ñdescriptorôWHILEñhsôleayô2,yó;ñskipñaddrôldbõ,yô;ñloopñifñcmdñvalidòWHILEñplòrts*ñexecuteñcmdñpointedñbyñydoExecòpshsòxù;ñsavesñtheñtokenñptròjsróstksizeó;ñgetñstackñsizeòcmpbò,y+÷;ñenoughñargñonñstck?òDOIFòloø;ñnoñ=>ñerrorôpulsòx÷;ñnotñenoughñparamsôbsróprvTokenôldyó#stackErrôbraóprErrorñ;ñprintñstackñerrñmsgòDOELSEôldbótimeEnò;ñtimingñenabled?ôDOIFòneôbsródoTimingò;ñyesñ=>ñdoñtimeôclrótimeEnô;ñclearñtimeñflagôDONEôjsró[,y]ô;ñexecuteñcmdòDONEòpulsòx,pcö;ñrestoreñtokenñptr*ñrewindñtoñstartñofñlastñtokenprvTokenòDOôldbó,-xõ;ñreadñprevñcharôcmpbò#32õ;ñtokenñseparatpr?òWHILEñhiø;ñnoñ=>ñloopòleaxò1,x÷;ñfixupñxòrts*ñadvanceñtoñnextñtokennxtTokenòDOôldbó,x+õ;ñreadñnextñcharôbeqóEXITô;ñendñofñstring=>exitôcmpbò#32õ;ñtokenñseparatorñ?òWHILEólsö;ñnoñ=>ñloopòleaxô-1,xô;ñcomensateñxòrts*ñreturnsñtheñfp-stackñlengthñinñregñDstksizeòlddó#fpstackò;ñloadñtopñofñstackòpshsòuòsubdò,s++ö;ñsubtractñcurrentòlsrdü;ñdivideñbyñfouròlsrdòrts*ñmesureñtheñaverageñtimeñusedñbyñañcmd*ñtoñdoñso,ñiterateñtheñcmdñagainñand*ñagainñonñañcloneñofñtheñstackñfor*ñTIMELP/10ñseconds.ñTheñaverageñtime*ñforñtheñcmdñisñtime/(#iteration*10)*ñinñsecond.TIMELPòequõ150doTimingòldxó#timingStròjsróputsö;ñprintsñañwaitñmsgòclraòclrbòstbóputcEnô;ñdisableñprintòstdótimeCtô;ñclearñclockñcounteròldxó#TIMELPó;ñtimeoutòDOôbsródoDryExecôadddò#1ö;ñ+1ñexcutionôDOIFñeqölddñ#-1õ;ñwrapped!öbrañEXIT2ó;ñstopñloopingôDONEôcmpxòtimeCtò;ñtimeoutñreachedñ?òWHILEñccø;ñnoñ=>ñloopòjsrófpldduô;ñ--ñ#iteròlddótimeCtô;òjsrófpldduô;ñ--ñ#iterñtime*ñcomputeñaverageñtimeñinñmsòjsrófpoveròjsrófp_m10òjsrófpoveròjsrófpdivòjsrófprrot*ñcomputeñflopsòjsrófp_m10òjsrófp_m10òjsrófpswapòjsrófpdivòincóputcEnô;ñenableñprintòldxó#timeResStròjsróputsö;ñprintñresultñmsgòjsródoDotõ;ñprintsñavgñtimeòldxó#flopsResStròjsróputsö;ñprintsñflopsñmsgòjmpódoDotõ;ñprintñflops*ñexecuteñtheñcommandñwithoutñaffecting*ñtheñstackdoDryExecòpshsòd,x,uõ;ñpreserveñregsòldbó-1,yö;ñgetñarityòDOIFòneôDOödecbø;ñarg-indexöstbó,-só;ñpreserveöldbó-1,yödecbø;ñpushñarg-1öjsrófppicköldbó,s+ôWHILEñneòDONEòjsró[,y]ö;ñexecuteñcmdòpulsòd,x,u,pc*ñgivenñañbufferñinñxñ(endingñinñy-1),ñr*ñresultñisñañnul-terminatedñstringgetsòleayò-1,yö;ñy=endñofñbuffer-1òpshsòd,y,xõ;ñpreserveñvaluesòclró,yø;ñmarkñendñofñbufòDOôjsró$E806ó;ñreadñañcharôtstbú;ñgotñitñ?ôbeqóREDOô;ñno=>readñagainôcmpbò#13õ;ñreturn?ôbeqóEXITô;ñyes=>exitñloopôcmpbò#8ö;ñbackôDOIFòeqöcmpxò2,só;ñalreadyñatñstart?öDOIFñneõ;ñno=>goñbackøleaxò-1,xølddó#1øbsróbackspöDONEöbraóREDO2ôDONEôcmpbò#9ö;ñrightôDOIFòeqöldbó,x+öDOIFñeqõ;ñendñofñbuffer?øleaxñ-1,xñ;ñyesñ=>ñgetñbackøldbó#7ò;ñbeepöDONEöbsróputcò;ñprintñcharöbraóREDO2ôDONEôcmpbò#10õ;ñdown-->resetñlineôDOIFòeqötfróx,dösubdò2,söbsróbackspöldxó2,söbraóREDO2ôDONEôcmpbò#11õ;ñupñ-->ñprintñprevôDOIFòeqöbsróputsöleaxò-1,xöbraóREDO2ôDONEôcmpbò#32õ;ñ<ñ'ñ'ôbloóREDOô;ñyesñ=>ñignoreôcmpbò#127ô;ñ>ñ127ôbhióREDOô;ñyesñ=>ñignoreôcmpxò4,sõ;ñatñendñofñbufferñ?ôDOIFòhsöldbó#7ô;ñbeepöbsróputcöbraóREDO2ôDONEôstbó,x+ôbsróputcòWHILEñraòclró,xø;ñendñofñstringòbsróprintlnó;ñprintsñcrlfòpulsòd,x,y,pc*ñprintsñañbackspaceñofñlengthñ"n"*ñ(inñregñD)backspòpshsòxù;ñsaveñregsòtfród,x÷;ñx=nòDOIFòneôldbó#8ö;ñprintñbackspaceôbsróbacksp2ñ;ñnñtimesôldbó#32õ;ñprintñspaceñnôbsróbacksp2ñ;ñtimesôldbó#8ö;ñthenñbackspaceôbsróbacksp2ñ;ñnñtimesñagainòDONEòpulsòx,pc*ñprintsñañcharñ(inñBñreg)ñnñtimes*ñ(inñXñreg)backsp2òpshsôxòDOôbsróputcôleaxò-1,xòWHILEñneòpulsôx,pc*ñprintsñañlineñpointedñbyñxñ(trashed)printlnòbsróputsòldxó#crlfòSKIP2û;ñskipñoverñbsrñputc*ñprintsñañnul-terminatedñstringòDOôbsróputcô;ñprintñcharputsôldbó,x+õ;ñloadñnextñcharòWHILEñneø;ñany?ñno=>ñloopòrts*ñprintsñañcharputcòtstóputcEnô;ñprintñenabled?òDOIFòeqôrtsû;ñnoñ=>ñdoñnothingòDONEòjmpó$E803õ;ñyesñ=>ñromñroutine*ñprintsñcurrentñfloatñinñoutbufdoDotòldxó#outbuf*ñwriteñcurrentñfloatñinñbufñpointed*ñbyñxñandñprintsñoutbufdoDot2òjsrófpwrxòldxó#outbufòbraóprintln*ñprintsñfullñstackdoDotSòjsróstksizeó;ñB=stackñsizeñ(%ñ256)òpshsòb,x,yòDOIFòneôDOödecböstbó,-söcomböaddbò1,söldyó#outbuföldaó#1öjsrófpwrbölddó#32+256*':ñ;ñaddñ':ñ'östdó,y++öldbó,söjsrófppicköleaxò,yöbsródoDot2öldbó,s+ôWHILEóneòDONEòpulsòb,x,y,pc*ñquitñtheñinterpreterdoQuitòclrórunningó;ñclearñflagòclró,xø;ñkillñtokenñbufferòrts*ñdoñnothingdoNopòrts*ñresetñfpuñstackdoZòlduó#fpstackòrts*ñprintsñtheñlistñofñpossibleñcommands*ñtheñarityñisñindicatedñinñtext*ñfontdoHelpòldxó#cmdsõ;ñcmdñlistòclróputcAttrò;ñnoñattributeñbyñdefòDOôbsródoHelpAttrôldaó#8ö;ñmaxñcmdñlenôDOöldbó,xô;ñgetñnextñcmdñcharöcmpbò#10ó;ñarityñreached?öDOIFòhsô;ñno=>advanceøleaxò1,xöDOELSEøldbó#32ñ;ñyes=>outputñspaceøclróputcAttrñ;ñclearñattriböDONEöbsróattrPutcödecaôWHILEñneôbsródoHelpArityôleaxò2,xõ;ñskipñoverñexecñaddrôldbó,xòWHILEñplòldxó#crlfòjmpóputs*ñloopñtillñarityñreacheddoHelpArityòDOôldbó,x+õ;ñgotñarity?ôcmpbò#10õ;ñnotñyet=>loopòWHILEñhsòrts*ñdetermineñañtextñattributeñaccording*ñtoñtheñarityñofñtheñcmdñpointdñbyñydoHelpAttròpshsòxòbsródoHelpArityòldxó#arityAttrbòldbób,xòstbóputcAttròpulsòx,pcNONEòequó%0000ñ;ñnoñattributeBOLDòequó%0001ñ;ñdisplayñboldITALòequó%0010ñ;ñitalicsUNDLòequó%0100ñ;ñunderlineRVIDòequó%1000ñ;ñreverseñvideoarityAttrbòfcbóNONEòfcbóBOLDòfcbóRVIDòfcbóRVID+BOLDòfcbóRVID+ITAL+BOLD*ñañmodifiedñvesionñofñputcñthatñcan*ñapplyñtextñattributeñtoñprinted*ñcharattrPutcòpshsòx,d÷;ñpreserveñregsòldxó$605Aõ;ñgetñcurñaddrñonñscròjsróputcö;ñprintñcharòldbó#0ø;ñgetñcurr.ñattributeòVARóputcAttr,1òlsrbü;ñboldñflagñsetñ?òDOIFòcsø;ñyes==>ôbsróboldô;ñmakeñcharñboldôleaxò320,xó;ñgoñdownñ8ñlinesôbraóEXITô;ñskipñlocalñroutineboldôbsró*+2õ;ñrepeatñ8ôbsró*+2ôbsró*+2ôldaó,xö;ñgetñvideoñbyteôlsraú;ñshiftñaddôoraó,xö;ñmergeñitñwithôstaó,xö;ñpreviousôleaxò-40,xó;ñgoñupñ1ñlineôrtsòDONEòlsrbü;ñitalicñflagñsetñ?òDOIFòcsôlslñ,xø;ñyesñ=>ñleftñshiftôlslñ-1*40,xó;ñ3ñbottomñlinesñandôlslñ-2*40,xó;ñrightñshiftñ3ñtopôlsrñ-5*40,xó;ñlinesôlsrñ-6*40,xôlsrñ-7*40,xòDONEòlsrbü;ñunderlineñflagñset?òDOIFòcsôcomó,xö;ñyesñ=>ñcompl.ñvideoòDONEòlsrbü;ñreverseñvideoñset?òDOIFòcsôbsróinvvidò;ñreverseñcharôleaxò320,xó;ñ8ñlineñdownôbraóEXITô;ñskipñlocalñroutineinvvidôbsró*+2õ;ñrepeatñ8ñtimesôbsró*+2ôbsró*+2ôcomó,xö;ñcomplementñvideoôleaxò-40,xó;ñ1ñlineñupôrtsòDONEòpulsòx,d,pcô;ñdone*ñcompareñ2ñfloatsñandñprintñ<ñ=ñ>*ñaccordinglydoCmpòjsrófpcmpõ;ñcompareòDOIFòeqôldbñ#'=òDOELSEôDOIFñhiöldbñ#'>ôDOELSEöldbñ#'<ôDONEòDONEòjsróputcö;ñprintñsylbolòjsrófp2dropó;ñdropñ2ñcharsòldxó#crlfõ;ñnewñlineòjmpóputs*ñinitñtimerñisrtimeInitòldxó#timeItõ;ñactivateñtimeròstxó$6027*ñstxó$6021òldaó$6019òoraó#32òstaó$6019òandccñ#255-$50òrts*ñstopñtimerñisrtimeExitòldaó$6019òandaò#255-32òstaó$6019òrts*ñtimerñisrtimeItòincótimeCt+1òDOIFñeqôincñtimeCtòDONEòjmpó$E830*ñflagñtimedñoperationtimeOnòincótimeEnòrts*ñ=====================================CMDñMACROòfccó\0ú;ñnameòfcbó\2ú;ñarityñ<ñ10òfdbó\1ú;ñfonctionñpointerôENDMcmdsòCMDó/?/,doHelp,0òCMDó/help/,doHelp,0òCMDó/quit/,doQuit,0òCMDó/time/,timeOn,0òCMDó/.s/,doDotS,0òCMDó/pi/,fppi,0òCMDó/n.nnE+n/,doNop,0òCMDó/+/,fpadd,2òCMDó/-/,fpsub,2òCMDó/*/,fpmul,2òCMDó%/%,fpdiv,2òCMDó/%/,fpmod,2òCMDó/rem/,fprem,2òCMDó/**/,fppow,2òCMDó/*2/,fpshl,1òCMDó%/2%,fpshr,1òCMDó%1/%,fpinv,1òCMDó/abs/,fpabs,1òCMDó/**2/,fpsqr,1òCMDó/sqrt/,fpsqrt,1òCMDó%1/sqrt%,fpinvsqrt,1òCMDó/sin/,fpsin,1òCMDó/cos/,fpcos,1òCMDó/tan/,fptan,1òCMDó/atan/,fpatan,1òCMDó/ln/,fpln,1òCMDó/exp/,fpexp,1òCMDó/!/,fpgammap1,1òCMDó/trunc/,fptrunc,1òCMDó/frac/,fpfrac,1òCMDó/floor/,fpfloor,1òCMDó/ceil/,fpceil,1òCMDó/round/,fpround,1òCMDó/cmp/,doCmp,2òCMDó/./,doDot,1òCMDó/z/,doZ,0òCMDó/nop/,doNop,0òCMDó/drop/,fpdrop,1òCMDó/dup/,fpdup,1òCMDó/swap/,fpswap,2òCMDó/2drop/,fpdrop,2òCMDó/2dup/,fp2dup,2òCMDó/over/,fpover,2òCMDó/rot/,fplrot,3òCMDó/-rot/,fprrot,3òCMDó%1//%,fpinv_vnrd,1òCMDó%1///%,fpinv_goldschmidt,1òCMDó%1////%,fpinv_quake,1òCMDó%rnd%,fprnd,0òfcbó-1ö;ñendñofñcmdswelcomeòfccó/RPNñcalc/òfccó/,ñbyñSamuelñDEVULDER/òfccó/ñ2019/coloroffòfcbó$1B,$68crlfòfcbó13,10,0byeòfccó/Bye.../coloronòfcbó$1B,$69òfcbó0stackErròfccó%!!!ñ%òfcbó7,0syntaxErròfccó/???ñ/òfcbó7,0timingStròfccó/timingñforñ/òfcbó(TIMELP/100)+'0òfcbó((TIMELP/10)%10)+'0òfccó/./òfcbóTIMELP%10+'0òfccó/s.../òfcbó0timeResStròfcbó13,$18òfccó/time(ms)ñ=ñ/òfcbó0flopsResStròfccó/flopsô=ñ/òfcbó0*ñ=====================================runningòfcbó-1ò;ñstillñinterpretñ?putcEnòfcbó-1ò;ñputcñenabledñ?timeEnòfcbó0ó;ñtimingñenabledñ?timeCtòfdbó0ó;ñtimerñcounter*ñ=====================================òfcbó0ó;ñsentinelinpbufòrmbó256,0inpendoutbufòrmbó256outendfpstackendòrmbó128*4fpstackòendómain